;
; M32ASSEM_CH6.asm
;
; Created: 07/03/2018 12:47:25
; Author : Mahmoud Saad
;

/*
.DEF COUNTER=R16
.MACRO ITOA
	  LOOP_ALL :
				LDI @0,@1
				ADD @0,R19
				DEC COUNTER
	  BRNE LOOP_ALL
.ENDMACRO
*/

/*
.MACRO DELAY
LDI @0,@1
L:
NOP
NOP
NOP
DEC @0
BRNE L
.ENDMACRO
*/
/*
.MACRO OUT_DATA
.LDI @0,@1
.LDI @2,@3
.LDI @4,@5
L:
OUT PORTA,@0
DELAY R30,0X60
OUT PORTA,@2
DELAY R30,0X50
OUT PORTA,@4
DELAY R30,0X40
.ENDMACRO
*/
/*
.INCLUDE "M32DEF.INC"
.MACRO DELAY
LDI @0,@1
L1 : LDI @2,@3
L2 :
	NOP
	NOP
	NOP
	DEC @2
	BRNE L2
	DEC @0
	BRNE L1
.ENDMACRO

.MACRO DOUTA
LDI @4,@5
OUT PORTA,@4
DELAY @0,@1,@2,@3
.ENDMACRO
LDI R16,0XFF
OUT DDRA,R16
MAIN: DOUTA R16,100,R17,100,R18,0X50
HERE: RJMP HERE
*/








/*
.INCLUDE "M32DEF.INC"

.ORG 0X00
;INITIALIZING THE STACK WHEN USING SUBROUTINES!!!!
LDI R16,HIGH(RAMEND)
OUT SPH,R16
LDI R16,LOW(RAMEND)
OUT SPL,R16

.EQU COUNTER=0X04
;			LDI R16,0X00
;			OUT DDRB,R16
;			LDI R16,0XFF
;			OUT DDRC,R16


MAIN :
			;POINT TO THE PROM MEMORY REGION
			LDI ZH,HIGH(PROM_DATA<<1)
			LDI ZL, LOW(PROM_DATA<<1)
			LDI R16,0XFF
			OUT DDRA,R16
			;NOW Z POINTS TO THE PROG REGION
			;LOOP TILL ALL ARE OUT
			LDI R16,COUNTER
OUT_ALL :   RCALL PROM_2_REGS
			;DATA IS IN REGISTER R17
			RCALL BCD_2_ASCII
			;DATA_IN R17 & R18 >>R17 THE LOWER NIPPLE
			RCALL ASCII_2_PORT
			;DATA IS OUT NOW & PROG FINISHED
			DEC R16 ;DECREMENT THE COUNTER
			BRNE OUT_ALL
THX :       RJMP THX
RJMP MAIN
								;	*********************************************
ASCII_2_PORT :
			OUT PORTA,R17
			RCALL DELAY
			OUT PORTA,R18
			RCALL DELAY
			RET
								;	*********************************************
BCD_2_ASCII:
			MOV R18,R17 ;NOW R18=R17=VAL
			ANDI R17,0X0F
			ORI R17,30
			SWAP R18
			ANDI R18,0X0F
			ORI R18,30
			RET
								;	*********************************************
PROM_2_REGS:
			LPM R17,Z+
			RET	
								;	*********************************************
DELAY :
			LDI R30,100
LOOP_1 :	LDI R31,10
LOOP_2 :
			NOP
			NOP
			NOP
			NOP
			NOP
			DEC R31
			BRNE LOOP_2	
			DEC R30
			BRNE LOOP_1
RET
								;	********************************************
;PROM DATA STORED AS BACKED BCD 
.ORG 0X300
PROM_DATA : .DB 0X25,0X30,0X35,0X40

*/
;READING FROM EEPROM TO PORTB
/*
MAIN :  LDI R16,0XFF
		OUT DDRB,R16
CHECK_EEWE :SBIC EECR,EEWE
			RJMP CHECK_EEWE
			LDI R16,0X00
			OUT EEARH,R16
			LDI R16,0X5F
			OUT EEARL,R16
			SBI EECR,EERE
			IN R16,EEDR
			OUT PORTB,R16
	HERE :	 RJMP HERE
RJMP MAIN ;WORKS!!!!!!!!!!!!!
*/




;WRITING TO THE EEPROM IN ASSEM :D
/*
MAIN :

CHECK_EEWE : SBIC EECR,EEWE
			 RJMP CHECK_EEWE
			 LDI R16,0X00
			 OUT EEARH,R16
			 LDI R16,0X50
			 OUT EEARL,R16
			 LDI R16,0X50
			 OUT EEDR,R16
			 SBI EECR,EEMWE
			 SBI EECR,EEWE
	HERE :	 RJMP HERE

RJMP MAIN;WORKS!!!!!!!!
*/


/*		WORKES!!!!!!!!!
MAIN :
		IN R16,PINB
		ANDI R16,0X0F

		LDI ZL,LOW(XSQR<<1)
		LDI ZH,HIGH(XSQR<<1)

		ADD ZL,R16

		LPM R17,Z
		
		LDI ZL,LOW(X2<<1)
		LDI ZH,HIGH(X2<<1)
		
		ADD ZL,R16

		LPM R18,Z
		
		LDI R16,3
		ADD R16,R17
		ADD R16,R18
		OUT PORTC,R16
		RJMP MAIN

.ORG 0X20
	XSQR :
		.DB 0,1,4,9,16,25,36,49,56,81

.ORG 0X50
	X2 :
		.DB 0,2,4,6,8,10,12,14,16,18

*/
/*
		LDI R16,0X00
		OUT DDRB,R16
		LDI R16,0XFF
		OUT DDRC,R16

		LDI ZH,HIGH(TABLE<<1)
MAIN :	LDI ZL,LOW(TABLE<<1)

		IN R16,PINB
		ANDI R16,0X0F
		ADD ZL,R16
		LPM R16,Z
		OUT PORTC,R16
		RJMP MAIN
.ORG 0X10
	TABLE :
		.DB 3,6,11,18,27,38,51,66,83,102
*/










;LDI R16,0X00
;MAIN :
/*.ORG 0X500
.DB 1,2,3,4,5,6,7,8,9,10
.ORG 0X520
.DB 'H','I'
.ORG 0X530
.DB "HI,MR.ROM!"
LDI R16,0XFF
OUT DDRA,R16
*/

/*
MAIN :
		LDI R16,'H'
		STS LOW(0X300),R16
		LDI R16,'I'
		STS HIGH(0X300),R16
		LDI R16,','
		STS LOW(0X301),R16
		LDI R16,'M'
		STS HIGH(0X301),R16
		LDI R16,'R'
		STS LOW(0X302),R16
		LDI R16,'-'
		STS HIGH(0X302),R16
		LDI R16,'M'
		STS LOW(0X303),R16
		LDI R16,'S'
		STS HIGH(0X303),R16
		LDI R16,'A'
		STS LOW(0X304),R16


		CALL DELAY
		LDI XL,0X00
		LDI XH,0X3
		CALL DELAY
		
		LDI R29,9

LOOPING_OUT :
LD R16,X+
OUT PORTA,R16
DEC R29
BRNE LOOPING_OUT




RJMP MAIN
*/



		
;RJMP MAIN
/*
HERE : 
LDI ZL,0X30
LDI ZH,0X5
LDI R17,10
MINI_LOOP :
LPM R16,Z+
OUT PORTA,R16
CALL DELAY
DEC R17
BRNE MINI_LOOP
RJMP HERE
*/
/*
		INC R16
		OUT PORTB,R16
		CALL DELAY
*/
/*
LDI R16,10
LOOP_1 :LDI R17,10
LOOP_2 :LDI R18,10
LOOP_3 :LDI R19,10
LOOP_4 :LDI R20,10
LOOP_5 :		
		INC XL
		DEC R20
		BRNE LOOP_5
		DEC R19
		BRNE LOOP_4
		DEC R18
		BRNE LOOP_3
		DEC R17
		BRNE LOOP_2
		DEC R16
		BRNE LOOP_1
		
*/
/*
DELAY :
		LDI R30,100
LOOP_1 :LDI R31,100
LOOP_2 :
		NOP
		NOP
		NOP
		NOP
		NOP
		DEC R31
		BRNE LOOP_2	
		DEC R30
		BRNE LOOP_1
RET
*/